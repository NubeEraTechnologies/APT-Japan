name: terraform-deploy-oidc

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write   # <-- REQUIRED for OIDC token

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}


      - name: Verify az account
        run: az account show
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      # example: terraform steps or other actions...
      - name: Terraform init
        run: |
          cd terraform
          terraform init
          
      - name: Select Azure Region with 2 vCPU & 8GB support
        id: region
        run: |
          regions=(eastus eastus2 centralus westus westus2 westus3 northeurope westeurope uksouth)
          sizes=(Standard_D2s_v3 Standard_D2as_v5 Standard_D2ls_v5 Standard_D2_v2)
          
          for r in "${regions[@]}"; do
            for s in "${sizes[@]}"; do
              echo "Testing $s in $r"
              count=$(az vm list-skus \
                --location $r \
                --resource-type virtualMachines \
                --size $s \
                --query "[?capabilities[?name=='vCPUs'].value=='2'] | length(@)" \
                -o tsv)
          
              if [ "$count" -gt 0 ]; then
                echo "FOUND REGION=$r SIZE=$s"
                echo "region=$r" >> $GITHUB_OUTPUT
                echo "size=$s"   >> $GITHUB_OUTPUT
                exit 0
              fi
            done
          done
          
          echo "No available region found!"
          exit 1


      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: terraform
        env:
          TF_VAR_region: ${{ steps.region.outputs.region }}
          TF_VAR_vm_size: ${{ steps.region.outputs.size }}


      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve
  
      - name: Save SSH Private Key
        run: |
          echo "${{ steps.tf-outputs.outputs.private_key }}" > ansible/private.pem
          chmod 600 ansible/private.pem
  
      - name: Create Ansible Inventory
        run: |
          echo "[azure_vm]" > ansible/inventory
          echo "${{ steps.tf-outputs.outputs.public_ip }}" >> ansible/inventory
  
      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible
  
      - name: Run Ansible
        run: |
          ansible-playbook -i ansible/inventory ansible/install-packages.yml \
            --private-key ansible/private.pem \
            -u azureuser
